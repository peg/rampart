name: Deploy Docs

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'docs-site/**'
      - 'mkdocs.yml'
      - '.github/workflows/docs.yml'

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'

      - run: pip install mkdocs-material mkdocs-minify-plugin mkdocs-d2-plugin

      - name: Install D2
        run: curl -fsSL https://d2lang.com/install.sh | sh -s --
        env:
          SHELL: /bin/bash

      - name: Build docs
        run: mkdocs build
        env:
          PATH: /home/runner/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

      # Deploy to peg/rampart-docs (the repo that serves docs.rampart.sh via GitHub Pages).
      # Requires a PAT with contents:write on peg/rampart-docs stored as DOCS_DEPLOY_TOKEN.
      - name: Push to peg/rampart-docs
        env:
          DOCS_DEPLOY_TOKEN: ${{ secrets.DOCS_DEPLOY_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          cd /tmp
          git clone --depth=1 https://x-access-token:${DOCS_DEPLOY_TOKEN}@github.com/peg/rampart-docs.git rampart-docs
          rsync -a --delete --exclude='.git' "${GITHUB_WORKSPACE}/site/" rampart-docs/
          cd rampart-docs
          git add -A
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "docs: deploy from peg/rampart@${GITHUB_SHA::8}"
          git push origin gh-pages
