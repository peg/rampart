<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rampart Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #09090b; --surface: #18181b; --surface-2: #1e1e22; --surface-3: #27272a;
  --border: #27272a; --border-light: #3f3f46;
  --text: #a1a1aa; --text-bright: #e4e4e7; --heading: #fafafa;
  --accent: #FF6392; --accent-dim: #cc4f75;
  --green: #22c55e; --red: #ef4444; --orange: #f59e0b;
  --radius: 6px;
}
[data-theme="light"] {
  --bg: #f8f9fa; --surface: #ffffff; --surface-2: #f1f3f5; --surface-3: #e9ecef;
  --border: #dee2e6; --border-light: #ced4da;
  --text: #495057; --text-bright: #212529; --heading: #000000;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',system-ui,sans-serif;font-size:13px;line-height:1.4;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.mono{font-family:'JetBrains Mono',monospace;font-size:12px}
.wrap{max-width:1200px;margin:0 auto;padding:0 16px}

/* Auth bar */
#auth-bar{padding:12px 0;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border)}
#auth-bar .logo{font-weight:700;font-size:15px;color:var(--heading);margin-right:auto;display:flex;align-items:center;gap:6px}
#auth-bar .logo span{color:var(--accent)}
#token-input{background:var(--surface);border:1px solid var(--border);color:var(--text-bright);padding:6px 10px;border-radius:var(--radius);width:260px;font-size:12px;outline:none}
#token-input:focus{border-color:var(--accent)}
#token-input::placeholder{color:#52525b}
#connect-btn{background:var(--accent);color:#fff;border:none;padding:6px 14px;border-radius:var(--radius);font-size:12px;font-weight:600;cursor:pointer}
#connect-btn:hover{background:var(--accent-dim)}
#theme-toggle{background:var(--surface);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;border-radius:var(--radius);font-size:14px;cursor:pointer;line-height:1}
#theme-toggle:hover{border-color:var(--accent)}
.conn-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:4px}
.conn-dot.ok{background:var(--green)}.conn-dot.err{background:var(--red)}.conn-dot.wait{background:var(--orange)}

/* Error banner */
#error-banner{display:none;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);color:var(--red);padding:8px 16px;border-radius:var(--radius);margin:8px 0;font-size:12px;align-items:center;gap:8px}
#error-banner button{background:var(--red);color:#fff;border:none;padding:3px 10px;border-radius:var(--radius);cursor:pointer;font-size:11px}

/* Tabs */
.tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-top:2px}
.tab-btn{background:none;border:none;color:var(--text);padding:8px 16px;font-size:13px;cursor:pointer;border-bottom:2px solid transparent;font-weight:500;display:flex;align-items:center;gap:6px}
.tab-btn:hover{color:var(--text-bright)}.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-badge{background:var(--accent);color:#fff;font-size:10px;font-weight:700;padding:1px 5px;border-radius:10px;min-width:18px;text-align:center}
.tab-panel{display:none}.tab-panel.active{display:block}

/* Table */
.tbl{width:100%;border-collapse:collapse}
.tbl th{text-align:left;padding:6px 8px;font-size:11px;font-weight:600;color:#52525b;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:1;overflow:hidden;position:relative}
.tbl th .resize-handle{position:absolute;right:0;top:0;bottom:0;width:4px;cursor:col-resize;background:transparent;z-index:2}
.tbl th .resize-handle:hover,.tbl th .resize-handle.active{background:var(--accent)}
.tbl td{padding:5px 8px;border-bottom:1px solid var(--border);vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:0}
.tbl tr.row:hover{background:var(--surface)}
.tbl tr.row{cursor:pointer;transition:background .15s}
.tbl tr.row.new-item{animation:fadeHighlight 2s ease-out}
.tbl tr.row.dangerous{border-left:3px solid var(--orange)}
.tbl tr.flash-green{background:rgba(34,197,94,.15)!important}
.tbl tr.flash-red{background:rgba(239,68,68,.15)!important}
@keyframes fadeHighlight{from{background:rgba(255,99,146,.12)}to{background:transparent}}

/* Detail row */
.detail-row td{padding:0!important;border-bottom:1px solid var(--border)}
.detail-inner{max-height:0;overflow:hidden;transition:max-height .25s ease;padding:0 8px}
.detail-row.open .detail-inner{max-height:300px;padding:10px 8px}
.detail-inner .kv{display:grid;grid-template-columns:100px 1fr;gap:4px 12px;font-size:12px}
.detail-inner .kv dt{color:#52525b;font-weight:500}.detail-inner .kv dd{color:var(--text-bright);word-break:break-all}

/* Dot */
.dot{width:6px;height:6px;border-radius:50%;display:inline-block;flex-shrink:0}
.dot.pending{background:var(--orange)}.dot.approved{background:var(--green)}.dot.denied{background:var(--red)}.dot.always{background:var(--accent)}

/* Action buttons */
.actions{display:flex;gap:4px;justify-content:flex-end;white-space:nowrap;flex-wrap:nowrap}
.act-btn{border:1px solid transparent;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;line-height:1.4;background:transparent}
.act-btn.approve{border-color:var(--green);color:var(--green)}.act-btn.approve:hover{background:rgba(34,197,94,.1)}
.act-btn.always{border-color:var(--border-light);color:var(--text-bright)}.act-btn.always:hover{background:rgba(255,255,255,.06)}
.act-btn.deny{border-color:var(--red);color:var(--red)}.act-btn.deny:hover{background:rgba(239,68,68,.1)}
.act-btn.revoke{border-color:var(--red);color:var(--red);font-size:11px;padding:2px 8px}
.act-btn.revoke:hover{background:rgba(239,68,68,.1)}
.act-btn.reload{background:var(--surface-3);color:var(--text-bright);border:1px solid var(--border);padding:5px 14px;border-radius:var(--radius);font-size:12px}
.act-btn.reload:hover{background:var(--border-light)}

/* Timer */
.timer{font-variant-numeric:tabular-nums;min-width:36px;display:inline-block;text-align:right;font-family:'JetBrains Mono',monospace;font-size:11px}

/* Badges */
.badge{font-size:10px;font-weight:600;padding:1px 6px;border-radius:3px;text-transform:uppercase}
.badge.approved{background:rgba(34,197,94,.15);color:var(--green)}
.badge.denied{background:rgba(239,68,68,.12);color:var(--red)}
.badge.always-allowed{background:rgba(255,99,146,.12);color:var(--accent)}
.badge.allow{background:rgba(34,197,94,.15);color:var(--green)}
.badge.deny{background:rgba(239,68,68,.12);color:var(--red)}
.badge.require_approval{background:rgba(245,158,11,.12);color:var(--orange)}
.badge.blocked{background:rgba(239,68,68,.12);color:var(--red)}
.badge.danger{background:rgba(245,158,11,.15);color:var(--orange);font-size:10px;padding:1px 5px;border-radius:3px;font-weight:700;font-family:monospace;text-transform:none}

/* Toast */
#toast{position:fixed;bottom:20px;right:20px;background:var(--surface-2);border:1px solid var(--border);color:var(--text-bright);padding:8px 16px;border-radius:var(--radius);font-size:12px;opacity:0;transition:opacity .3s;pointer-events:none;z-index:100}
#toast.show{opacity:1}

/* Empty state */
.empty{text-align:center;padding:40px 0;color:#52525b;font-size:13px}

/* Auth help */
.auth-help{font-size:11px;color:#52525b;margin-top:4px}

/* Bulk action bar */
#bulk-bar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(24,24,27,.85);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--border-light);color:var(--text-bright);padding:10px 20px;border-radius:var(--radius);font-size:13px;display:none;align-items:center;gap:12px;z-index:200;box-shadow:0 4px 24px rgba(0,0,0,.4)}
[data-theme="light"] #bulk-bar{background:rgba(255,255,255,.85)}
#bulk-bar .bulk-count{font-weight:600;min-width:80px}
#bulk-bar .act-btn{padding:4px 12px;font-size:12px}

/* Checkbox in table */
.tbl .chk-cell{width:28px;text-align:center;cursor:default}
.tbl .chk-cell input[type="checkbox"]{cursor:pointer;accent-color:var(--accent)}

/* Section divider */
.section-divider{display:flex;align-items:center;gap:8px;margin:20px 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.section-title{font-size:12px;font-weight:600;color:var(--text-bright);text-transform:uppercase;letter-spacing:.5px}
.count-badge{background:var(--surface-3);color:var(--text);font-size:10px;font-weight:600;padding:1px 6px;border-radius:10px}
.count-badge.has-items{background:rgba(239,68,68,.15);color:var(--red)}

/* History controls */
.hist-controls{display:flex;gap:8px;align-items:center;padding:10px 0;flex-wrap:wrap}
.hist-controls input[type="search"],.hist-controls input[type="date"]{background:var(--surface);border:1px solid var(--border);color:var(--text-bright);padding:5px 8px;border-radius:var(--radius);font-size:12px;outline:none}
.hist-controls input[type="search"]{flex:1;min-width:140px;max-width:280px}
.hist-controls input[type="search"]:focus,.hist-controls input[type="date"]:focus{border-color:var(--accent)}
.hist-controls button{background:var(--surface-3);color:var(--text-bright);border:1px solid var(--border);padding:5px 12px;border-radius:var(--radius);font-size:12px;cursor:pointer}
.hist-controls button:hover{background:var(--border-light)}

/* Stats bar */
.stats-bar{display:flex;gap:16px;padding:10px 0;border-bottom:1px solid var(--border);font-size:12px;flex-wrap:wrap}
.stat{display:flex;align-items:center;gap:4px}.stat b{color:var(--heading);font-variant-numeric:tabular-nums}

/* Filter pills */
.filter-pills{display:flex;gap:4px;padding:6px 0 10px;flex-wrap:wrap}
.pill{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:3px 10px;border-radius:12px;font-size:11px;cursor:pointer;font-weight:500}
.pill:hover{border-color:var(--border-light);color:var(--text-bright)}
.pill.active{background:rgba(255,99,146,.12);border-color:var(--accent);color:var(--accent)}

/* History table scroll wrapper */
.tbl-scroll{overflow-y:auto;max-height:60vh}

/* Policy card */
.policy-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin:12px 0}
.policy-card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.policy-kv{display:flex;flex-direction:column;gap:2px}
.policy-kv .pk-label{font-size:10px;font-weight:600;color:#52525b;text-transform:uppercase;letter-spacing:.5px}
.policy-kv .pk-value{font-size:13px;color:var(--text-bright);font-weight:500}
.policy-kv .pk-value.mono{font-family:'JetBrains Mono',monospace;font-size:11px;word-break:break-all}
.policy-unavail{color:#52525b;font-size:13px;font-style:italic}
.policy-actions{padding:8px 0 4px;display:flex;gap:8px;align-items:center}
.policy-actions .hint{font-size:11px;color:#52525b}

/* Sentinel for infinite scroll */
#hist-sentinel{height:4px;margin:4px 0}

/* Responsive */
@media(max-width:640px){
  .col-tool,.col-agent{display:none}
  .tbl td.cmd-col{max-width:none;white-space:normal;word-break:break-all}
  #token-input{width:160px}
  .stat:nth-child(n+4){display:none}
}
</style>
</head>
<body>

<div class="wrap">
  <!-- Auth -->
  <div id="auth-bar">
    <div class="logo"><span>Rampart</span></div>
    <button id="theme-toggle" title="Toggle theme">Dark</button>
    <input type="password" id="token-input" placeholder="API token" autocomplete="off">
    <button id="connect-btn">Connect</button>
    <span class="conn-dot" id="conn-dot"></span>
  </div>
  <p class="auth-help">Unauthorized? Check your token. Run <code>rampart serve</code> to see the full token on startup.</p>

  <div id="error-banner"><span id="error-msg"></span><button onclick="reconnect()">Retry</button></div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="active">Active<span class="tab-badge" id="badge-active" style="display:none">0</span></button>
    <button class="tab-btn" data-tab="history">History</button>
    <button class="tab-btn" data-tab="policy">Policy</button>
  </div>

  <!-- ═══ ACTIVE TAB ═══ -->
  <div class="tab-panel active" id="panel-active">
    <table class="tbl" id="pending-table">
      <thead><tr>
        <th class="chk-cell"><input type="checkbox" id="select-all" title="Select all"></th>
        <th style="width:20px"></th>
        <th class="cmd-col">Command</th>
        <th class="col-tool" style="width:60px">Tool</th>
        <th class="col-agent" style="width:80px">Agent</th>
        <th style="width:50px;text-align:right">Time</th>
        <th style="width:140px;text-align:right">Actions</th>
      </tr></thead>
      <tbody id="pending-body"></tbody>
    </table>
    <div class="empty" id="pending-empty">No pending approvals</div>

    <!-- Recent Denials feed -->
    <div class="section-divider">
      <span class="section-title">Recent Denials</span>
      <span class="count-badge" id="denials-badge">0</span>
    </div>
    <table class="tbl" id="denials-table">
      <thead><tr>
        <th style="width:90px">Time</th>
        <th style="width:70px">Tool</th>
        <th class="cmd-col">Command</th>
        <th style="width:160px">Reason</th>
      </tr></thead>
      <tbody id="denials-body"></tbody>
    </table>
    <div class="empty" id="denials-empty" style="display:none">No recent denials</div>
  </div>

  <!-- ═══ HISTORY TAB ═══ -->
  <div class="tab-panel" id="panel-history">
    <div class="stats-bar" id="hist-stats-bar">
      <div class="stat">Total: <b id="hs-total">—</b></div>
      <div class="stat">Approved: <b id="hs-approved">—</b></div>
      <div class="stat">Denied: <b id="hs-denied">—</b></div>
      <div class="stat">Blocked: <b id="hs-blocked">—</b></div>
    </div>

    <div class="hist-controls">
      <input type="search" id="hist-search" placeholder="Filter by command…">
      <input type="date" id="hist-date">
      <button onclick="loadHistoryTab(true)">Load</button>
      <button onclick="exportHistoryAudit()">Export</button>
    </div>

    <div class="filter-pills" id="filter-pills">
      <button class="pill active" data-filter="all">All</button>
      <button class="pill" data-filter="approved">Approved</button>
      <button class="pill" data-filter="denied">Denied</button>
      <button class="pill" data-filter="blocked">Blocked</button>
      <button class="pill" data-filter="allowed">Allowed</button>
    </div>

    <div class="tbl-scroll" id="hist-scroll-wrap">
      <table class="tbl" id="hist-table">
        <thead><tr>
          <th style="width:80px">Time</th>
          <th class="col-agent" style="width:80px">Agent</th>
          <th class="col-tool" style="width:60px">Tool</th>
          <th class="cmd-col">Command</th>
          <th style="width:110px">Outcome</th>
        </tr></thead>
        <tbody id="hist-body"></tbody>
      </table>
      <div class="empty" id="hist-empty" style="display:none">No events for this date</div>
      <div id="hist-sentinel" style="height:4px"></div>
    </div>
  </div>

  <!-- ═══ POLICY TAB ═══ -->
  <div class="tab-panel" id="panel-policy">
    <!-- Policy info card -->
    <div class="policy-card" id="policy-card">
      <div class="policy-unavail">Loading policy info…</div>
    </div>

    <div class="policy-actions">
      <button class="act-btn reload" onclick="reloadPolicy()">↺ Reload Policy</button>
      <span class="hint" id="reload-hint"></span>
    </div>

    <!-- Auto-Allowed Rules -->
    <div class="section-divider">
      <span class="section-title">Auto-Allowed Rules</span>
    </div>
    <table class="tbl" id="rules-table">
      <thead><tr>
        <th class="cmd-col">Command Pattern</th>
        <th class="col-tool" style="width:70px">Tool</th>
        <th style="width:150px">Created</th>
        <th style="width:80px;text-align:right">Actions</th>
      </tr></thead>
      <tbody id="rules-body"></tbody>
    </table>
    <div class="empty" id="rules-empty">No auto-allowed rules. Use 'Always Allow' on a pending approval to create one.</div>
  </div>
</div>

<div id="toast"></div>

<!-- Bulk action bar -->
<div id="bulk-bar">
  <span class="bulk-count" id="bulk-count">0 selected</span>
  <button class="act-btn approve" onclick="bulkAction('approve')">Approve All</button>
  <button class="act-btn deny" onclick="bulkAction('deny')">Deny All</button>
</div>

<script>
'use strict';
const DANGEROUS=[/^rm\s/,/^chmod\s/,/^chown\s/,/^kill\s/,/^killall\s/,/^pkill\s/,/^dd\s/,/^mkfs/,/^fdisk/,/^reboot/,/^shutdown/,/^halt/,/^systemctl\s+(stop|disable|restart)/,/\bsudo\b/,/\brm\s+-rf\b/,/^ssh\b.*\breboot\b/,/^curl\b.*\|\s*(ba)?sh/];
function isDangerous(cmd){return DANGEROUS.some(r=>r.test(cmd||''))}

let token='',pollTimer=null,connected=false,expandedId=null,initialPoll=true;
const pendingMap=new Map();
const selectedIds=new Set();

// ── Theme ──────────────────────────────────────────────────────────────────
function initTheme(){
  const saved=localStorage.getItem('rampart_theme')||'dark';
  document.documentElement.setAttribute('data-theme',saved);
  document.getElementById('theme-toggle').textContent=saved==='dark'?'Dark':'Light';
}
function toggleTheme(){
  const cur=document.documentElement.getAttribute('data-theme');
  const next=cur==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme',next);
  localStorage.setItem('rampart_theme',next);
  document.getElementById('theme-toggle').textContent=next==='dark'?'Dark':'Light';
}

// ── Column resize + persist ────────────────────────────────────────────────
function saveColWidths(table){
  const id=table.id;if(!id)return;
  const widths={};
  table.querySelectorAll('thead th').forEach((th,i)=>{if(th.style.width)widths[id+'_'+i]=th.style.width});
  const all=JSON.parse(localStorage.getItem('rampart_col_widths')||'{}');
  Object.assign(all,widths);localStorage.setItem('rampart_col_widths',JSON.stringify(all));
}
function restoreColWidths(){
  const all=JSON.parse(localStorage.getItem('rampart_col_widths')||'{}');
  document.querySelectorAll('.tbl').forEach(table=>{
    if(!table.id)return;
    const ths=table.querySelectorAll('thead th');let hasW=false;
    ths.forEach((th,i)=>{const w=all[table.id+'_'+i];if(w){th.style.width=w;th.style.minWidth=w;hasW=true}});
    if(hasW)table.style.tableLayout='fixed';
  });
}
function initResizeHandles(){
  document.querySelectorAll('.tbl th').forEach(th=>{
    if(th.querySelector('.resize-handle')||th.classList.contains('chk-cell'))return;
    const h=document.createElement('div');h.className='resize-handle';th.appendChild(h);
    let startX,startW;
    h.addEventListener('mousedown',e=>{
      e.preventDefault();e.stopPropagation();
      startX=e.pageX;startW=th.offsetWidth;h.classList.add('active');
      const table=th.closest('table');table.style.tableLayout='fixed';
      function onMove(e){th.style.width=(startW+(e.pageX-startX))+'px';th.style.minWidth=th.style.width}
      function onUp(){h.classList.remove('active');document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);saveColWidths(table)}
      document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp);
    });
  });
}

// ── Init ───────────────────────────────────────────────────────────────────
(function(){
  initTheme();restoreColWidths();initResizeHandles();

  const p=new URLSearchParams(location.search).get('token');
  if(p){token=p;localStorage.setItem('rampart_token',p)}
  else token=localStorage.getItem('rampart_token')||'';
  document.getElementById('token-input').value=token;
  if(token)connect();

  document.getElementById('theme-toggle').addEventListener('click',toggleTheme);
  document.getElementById('connect-btn').addEventListener('click',connect);
  document.getElementById('token-input').addEventListener('keydown',e=>{if(e.key==='Enter')connect()});

  // Tab switching
  document.querySelector('.tabs').addEventListener('click',e=>{
    const btn=e.target.closest('.tab-btn');if(!btn)return;
    switchTab(btn.dataset.tab);
  });

  // Pending table events
  document.getElementById('pending-table').addEventListener('click',handlePendingClick);

  // Select-all
  document.getElementById('select-all').addEventListener('change',function(e){
    e.stopPropagation();const checked=this.checked;
    document.querySelectorAll('#pending-body .row-chk').forEach(cb=>{
      cb.checked=checked;const id=cb.dataset.id;
      if(checked)selectedIds.add(id);else selectedIds.delete(id);
    });updateBulkBar();
  });

  // History: filter pills
  document.getElementById('filter-pills').addEventListener('click',e=>{
    const pill=e.target.closest('.pill');if(!pill)return;
    document.querySelectorAll('#filter-pills .pill').forEach(p=>p.classList.remove('active'));
    pill.classList.add('active');
    histActiveFilter=pill.dataset.filter;
    applyHistFilters();
  });

  // History: search
  document.getElementById('hist-search').addEventListener('input',function(){
    histSearch=this.value.trim().toLowerCase();applyHistFilters();
  });

  // History table: expand on click
  document.getElementById('hist-body').addEventListener('click',e=>{
    const row=e.target.closest('tr.row');if(!row)return;
    const det=row.nextElementSibling;if(!det||!det.classList.contains('detail-row'))return;
    det.classList.toggle('open');
  });

  // Visibility change
  document.addEventListener('visibilitychange',()=>{
    if(document.hidden)clearTimeout(pollTimer);
    else if(connected)poll();
  });
})();

// ── Helpers ────────────────────────────────────────────────────────────────
function todayStr(){return new Date().toISOString().slice(0,10)}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function setDot(cls){document.getElementById('conn-dot').className='conn-dot '+cls}
function showError(msg){const b=document.getElementById('error-banner');b.style.display='flex';document.getElementById('error-msg').textContent=msg}
function hideError(){document.getElementById('error-banner').style.display='none'}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}
function timeAgo(iso){
  const s=Math.floor((Date.now()-new Date(iso))/1000);
  if(s<60)return s+'s ago';if(s<3600)return Math.floor(s/60)+'m ago';
  return Math.floor(s/3600)+'h ago';
}

async function api(path,opts={}){
  const r=await fetch(path,{...opts,headers:{'Authorization':'Bearer '+token,...(opts.headers||{})}});
  if(!r.ok)throw new Error(r.status+' '+r.statusText);
  return r;
}

// ── Tab switching ──────────────────────────────────────────────────────────
function switchTab(name){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  const btn=document.querySelector(`.tab-btn[data-tab="${name}"]`);
  if(btn)btn.classList.add('active');
  const panel=document.getElementById('panel-'+name);
  if(panel)panel.classList.add('active');
  if(name==='history')onHistoryTabOpen();
  if(name==='policy')onPolicyTabOpen();
}

// ── Connection / Poll ──────────────────────────────────────────────────────
function connect(){
  token=document.getElementById('token-input').value.trim();if(!token)return;
  localStorage.setItem('rampart_token',token);
  initialPoll=true;setDot('wait');
  poll();
}
function reconnect(){hideError();connect()}

async function poll(){
  clearTimeout(pollTimer);
  try{
    const r=await api('/v1/approvals');const data=await r.json();
    initialPoll=false;
    if(!connected){
      connected=true;setDot('ok');hideError();
    }
    updatePending(data.approvals||[]);
    const delay=pendingMap.size>0?2000:5000;
    if(!document.hidden)pollTimer=setTimeout(poll,delay);
  }catch(e){
    if(initialPoll){initialPoll=false;pollTimer=setTimeout(poll,2000);return}
    connected=false;setDot('err');
    showError('Connection failed: '+e.message);
    pollTimer=setTimeout(poll,10000);
  }
}

// ── Pending (Active tab) ───────────────────────────────────────────────────
function extractCmd(a){
  if(a.command)return a.command;
  if(a.request&&a.request.command)return Array.isArray(a.request.command)?a.request.command.join(' '):a.request.command;
  if(a.description)return a.description;
  return a.id||'unknown';
}

function updatePending(approvals){
  const incoming=new Map(approvals.map(a=>[a.id,a]));
  for(const[id]of pendingMap){
    if(!incoming.has(id)){
      document.getElementById('row-'+id)?.remove();
      document.getElementById('det-'+id)?.remove();
      pendingMap.delete(id);selectedIds.delete(id);
    }
  }
  const tbody=document.getElementById('pending-body');
  const sorted=[...approvals].sort((a,b)=>(a.created_at||'').localeCompare(b.created_at||''));
  for(const a of sorted){
    if(pendingMap.has(a.id)){pendingMap.set(a.id,a);updateTimerCell(a)}
    else{
      pendingMap.set(a.id,a);
      const{row,detail}=createPendingRow(a);
      tbody.prepend(detail);tbody.prepend(row);
      row.classList.add('new-item');
    }
  }
  // Update badge
  const n=pendingMap.size;
  const badge=document.getElementById('badge-active');
  badge.textContent=n;badge.style.display=n?'':'none';
  document.getElementById('pending-empty').style.display=n?'none':'block';
  updateTimers();updateBulkBar();
}

function createPendingRow(a){
  const cmd=extractCmd(a);const danger=isDangerous(cmd);
  const tr=document.createElement('tr');tr.className='row'+(danger?' dangerous':'');tr.id='row-'+a.id;tr.dataset.id=a.id;
  tr.innerHTML=`<td class="chk-cell"><input type="checkbox" class="row-chk" data-id="${esc(a.id)}"></td>
    <td><span class="dot pending"></span>${danger?'<span class="badge danger" style="margin-left:4px">!</span>':''}</td>
    <td class="cmd-col mono" title="${esc(cmd)}">${esc(cmd)}</td>
    <td class="col-tool">${esc(a.tool||'')}</td>
    <td class="col-agent">${esc(a.agent||'')}</td>
    <td style="text-align:right"><span class="timer" id="timer-${esc(a.id)}"></span></td>
    <td><div class="actions">
      <button class="act-btn approve" data-action="approve" data-id="${esc(a.id)}" title="Approve">Approve</button>
      <button class="act-btn always" data-action="always" data-id="${esc(a.id)}" title="Always allow this command pattern">Always Allow</button>
      <button class="act-btn deny" data-action="deny" data-id="${esc(a.id)}" title="Deny">Deny</button>
    </div></td>`;

  const det=document.createElement('tr');det.className='detail-row';det.id='det-'+a.id;
  det.innerHTML=`<td colspan="7"><div class="detail-inner"><dl class="kv">
    <dt>ID</dt><dd class="mono">${esc(a.id)}</dd>
    <dt>Command</dt><dd class="mono">${esc(cmd)}</dd>
    <dt>Tool</dt><dd>${esc(a.tool||'—')}</dd>
    <dt>Agent</dt><dd>${esc(a.agent||'—')}</dd>
    <dt>Message</dt><dd>${esc(a.message||a.description||'—')}</dd>
    <dt>Created</dt><dd>${a.created_at?new Date(a.created_at).toLocaleString():'—'}</dd>
    <dt>Expires</dt><dd>${a.expires_at?new Date(a.expires_at).toLocaleString():'—'}</dd>
  </dl></div></td>`;
  return{row:tr,detail:det};
}

function handlePendingClick(e){
  if(e.target.classList.contains('row-chk')){
    e.stopPropagation();
    const id=e.target.dataset.id;
    if(e.target.checked)selectedIds.add(id);else selectedIds.delete(id);
    updateBulkBar();return;
  }
  const btn=e.target.closest('.act-btn');
  if(btn){
    e.stopPropagation();
    if(btn.dataset.action==='always'){
      const cmd=extractCmd(pendingMap.get(btn.dataset.id)||{});
      if(!confirm('Always Allow will create a permanent rule that auto-approves similar commands.\n\nCommand: '+cmd+'\n\nThis can be revoked later in the Policy tab. Continue?'))return;
    }
    resolveApproval(btn.dataset.id,btn.dataset.action);return;
  }
  if(e.target.closest('.chk-cell'))return;
  const row=e.target.closest('tr.row');if(!row)return;
  const id=row.dataset.id;
  const det=document.getElementById('det-'+id);if(!det)return;
  if(expandedId&&expandedId!==id)document.getElementById('det-'+expandedId)?.classList.remove('open');
  det.classList.toggle('open');
  expandedId=det.classList.contains('open')?id:null;
}

function updateBulkBar(){
  const n=selectedIds.size;
  const bar=document.getElementById('bulk-bar');
  bar.style.display=n?'flex':'none';
  document.getElementById('bulk-count').textContent=n+' selected';
  const allCbs=document.querySelectorAll('#pending-body .row-chk');
  const selAll=document.getElementById('select-all');
  selAll.checked=allCbs.length&&[...allCbs].every(cb=>cb.checked);
}

async function bulkAction(action){
  const ids=[...selectedIds];if(!ids.length)return;
  if(!confirm(`${action==='approve'?'Approve':'Deny'} ${ids.length} pending approval(s)?`))return;
  for(const id of ids){try{await resolveApproval(id,action)}catch(e){}}
  selectedIds.clear();updateBulkBar();
}

async function resolveApproval(id,action){
  const approved=action!=='deny';const persist=action==='always';
  const row=document.getElementById('row-'+id);
  if(row)row.classList.add(approved?'flash-green':'flash-red');
  try{
    await api('/v1/approvals/'+id+'/resolve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({approved,resolved_by:'dashboard',persist})});
    setTimeout(()=>{
      document.getElementById('row-'+id)?.remove();
      document.getElementById('det-'+id)?.remove();
      pendingMap.delete(id);selectedIds.delete(id);
      const n=pendingMap.size;
      const badge=document.getElementById('badge-active');
      badge.textContent=n;badge.style.display=n?'':'none';
      if(!n)document.getElementById('pending-empty').style.display='block';
      updateBulkBar();
    },400);
    if(persist)toast('Rule saved — always allowed');
  }catch(e){toast('Error: '+e.message)}
}

// ── Timers ─────────────────────────────────────────────────────────────────
function updateTimers(){
  for(const[,a]of pendingMap)updateTimerCell(a);
  if(pendingMap.size&&!document.hidden)requestAnimationFrame(()=>setTimeout(updateTimers,1000));
}
function updateTimerCell(a){
  const el=document.getElementById('timer-'+a.id);if(!el)return;
  if(!a.expires_at){el.textContent='—';return}
  const rem=Math.max(0,Math.floor((new Date(a.expires_at)-Date.now())/1000));
  const m=Math.floor(rem/60),s=rem%60;
  el.textContent=m+':'+String(s).padStart(2,'0');
  el.style.color=rem<30?'var(--red)':rem<60?'var(--orange)':'';
}

// ── Recent Denials ─────────────────────────────────────────────────────────
let denialsTimer=null;

async function loadRecentDenials(){
  clearTimeout(denialsTimer);
  try{
    const [r1,r2]=await Promise.allSettled([
      api('/v1/audit/events?action=denied&limit=10'),
      api('/v1/audit/events?action=deny&limit=10'),
    ]);
    const e1=r1.status==='fulfilled'?(await r1.value.json()).events||[]:[];
    const e2=r2.status==='fulfilled'?(await r2.value.json()).events||[]:[];
    const seen=new Set();
    const combined=[...e1,...e2].filter(ev=>{
      const k=ev.id||(ev.timestamp+ev.command);
      if(seen.has(k))return false;seen.add(k);return true;
    }).sort((a,b)=>(b.timestamp||'').localeCompare(a.timestamp||'')).slice(0,10);
    renderDenials(combined);
  }catch(e){/* silently ignore */}
  denialsTimer=setTimeout(loadRecentDenials,30000);
}

function renderDenials(events){
  const tbody=document.getElementById('denials-body');
  const empty=document.getElementById('denials-empty');
  const badge=document.getElementById('denials-badge');
  tbody.innerHTML='';
  badge.textContent=events.length;
  badge.className='count-badge'+(events.length?' has-items':'');
  if(!events.length){empty.style.display='block';return}
  empty.style.display='none';
  events.forEach(ev=>{
    const cmd=ev.command||ev.description||'—';
    const danger=isDangerous(cmd);
    const tr=document.createElement('tr');
    tr.className='row'+(danger?' dangerous':'');
    const t=ev.timestamp?new Date(ev.timestamp).toLocaleTimeString():'—';
    tr.innerHTML=`<td style="font-size:11px;white-space:nowrap">${esc(t)}</td>
      <td>${esc(ev.tool||'—')}</td>
      <td class="cmd-col mono" title="${esc(cmd)}">${esc(cmd)}</td>
      <td style="font-size:11px;color:#52525b">${esc(ev.reason||ev.message||'—')}</td>`;
    tbody.append(tr);
  });
}

// Start denials polling when connected
const _origPoll=poll;
let _denialsStarted=false;
async function pollAndStartDenials(){
  await _origPoll.apply(this,arguments);
  if(connected&&!_denialsStarted){_denialsStarted=true;loadRecentDenials()}
}
// Patch poll to kick denials feed on first connect
(()=>{
  const orig=poll;
  window.poll=async function(){
    await orig();
    if(connected&&!_denialsStarted){_denialsStarted=true;loadRecentDenials()}
  };
})();

// ── History Tab ────────────────────────────────────────────────────────────
let histEvents=[];let histFiltered=[];
let histOffset=0;let histHasMore=false;
let histActiveFilter='all';let histSearch='';
let histObserver=null;let histLoading=false;
const HIST_PAGE=100;

function onHistoryTabOpen(){
  if(!histEvents.length){
    document.getElementById('hist-date').value=todayStr();
    loadHistoryTab(true);
  }
}

async function loadHistoryTab(reset){
  if(histLoading)return;histLoading=true;
  if(reset){histOffset=0;histEvents=[];document.getElementById('hist-body').innerHTML=''}
  const date=document.getElementById('hist-date').value||todayStr();
  try{
    const r=await api(`/v1/audit/events?date=${date}&limit=${HIST_PAGE}&offset=${histOffset}`);
    const data=await r.json();
    const evs=data.events||[];
    histEvents=[...histEvents,...evs];
    histOffset+=evs.length;
    histHasMore=evs.length>=HIST_PAGE;
    applyHistFilters();
    await loadHistStats(date);
  }catch(e){toast('History error: '+e.message)}
  histLoading=false;
}

async function loadHistStats(date){
  try{
    const r=await api(`/v1/audit/stats?from=${date}&to=${date}`);
    const s=await r.json();
    const ba=s.by_action||{};
    const approved=(ba.approved||0)+(ba.allow||0);
    const denied=(ba.denied||0);
    const blocked=(ba.deny||0);
    document.getElementById('hs-total').textContent=s.total_events||0;
    document.getElementById('hs-approved').textContent=approved;
    document.getElementById('hs-denied').textContent=denied;
    document.getElementById('hs-blocked').textContent=blocked;
  }catch(e){/* silently ignore if stats endpoint unavailable */}
}

function applyHistFilters(){
  const f=histActiveFilter;const q=histSearch;
  histFiltered=histEvents.filter(ev=>{
    if(q){const cmd=(ev.command||ev.description||'').toLowerCase();if(!cmd.includes(q))return false}
    if(f==='all')return true;
    if(f==='approved')return ev.action==='approved'||ev.action==='allow';
    if(f==='denied')return ev.action==='denied';
    if(f==='blocked')return ev.action==='deny';
    if(f==='allowed')return ev.action==='allow';
    return true;
  });
  renderHistEvents();
}

function renderHistEvents(){
  const tbody=document.getElementById('hist-body');
  const empty=document.getElementById('hist-empty');
  tbody.innerHTML='';
  if(!histFiltered.length){empty.style.display='block';return}
  empty.style.display='none';
  histFiltered.forEach(ev=>appendHistRow(ev,tbody));
  // Sentinel for infinite scroll
  if(histHasMore){
    const sentinel=document.createElement('tr');sentinel.id='hist-sentinel-row';
    sentinel.innerHTML='<td colspan="5" style="text-align:center;padding:8px;color:#52525b;font-size:11px">Loading more…</td>';
    tbody.append(sentinel);
    if(histObserver)histObserver.disconnect();
    const wrapper=document.getElementById('hist-scroll-wrap');
    histObserver=new IntersectionObserver(entries=>{
      if(entries[0].isIntersecting){histObserver.disconnect();loadHistoryTab(false)}
    },{root:wrapper,threshold:0.1});
    histObserver.observe(sentinel);
  }
}

function appendHistRow(ev,tbody){
  const cmd=ev.command||ev.description||'—';
  const danger=isDangerous(cmd);
  const action=ev.action||'';
  const t=ev.timestamp?new Date(ev.timestamp).toLocaleTimeString():'—';
  const tr=document.createElement('tr');
  tr.className='row'+(danger?' dangerous':'');
  const badgeCls=action==='allow'?'allow':action==='deny'?'deny':action==='denied'?'denied':action==='approved'?'approved':action==='require_approval'?'require_approval':'';
  tr.innerHTML=`<td style="font-size:11px;white-space:nowrap">${esc(t)}</td>
    <td class="col-agent">${esc(ev.agent||'—')}</td>
    <td class="col-tool">${esc(ev.tool||'—')}</td>
    <td class="cmd-col mono" title="${esc(cmd)}">${esc(cmd)}</td>
    <td><span class="badge ${badgeCls}">${esc(action||'—')}</span></td>`;
  const det=document.createElement('tr');det.className='detail-row';
  det.innerHTML=`<td colspan="5"><div class="detail-inner"><dl class="kv">
    <dt>Command</dt><dd class="mono">${esc(cmd)}</dd>
    <dt>Tool</dt><dd>${esc(ev.tool||'—')}</dd>
    <dt>Agent</dt><dd>${esc(ev.agent||'—')}</dd>
    <dt>Action</dt><dd>${esc(action||'—')}</dd>
    <dt>Reason</dt><dd>${esc(ev.reason||ev.message||'—')}</dd>
    <dt>Time</dt><dd>${ev.timestamp?new Date(ev.timestamp).toLocaleString():'—'}</dd>
  </dl></div></td>`;
  tbody.append(tr);tbody.append(det);
}

async function exportHistoryAudit(){
  const date=document.getElementById('hist-date').value||todayStr();
  try{
    const r=await api(`/v1/audit/export?date=${date}`);const blob=await r.blob();
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`audit-${date}.jsonl`;a.click();
  }catch(e){toast('Export error: '+e.message)}
}

// ── Policy Tab ─────────────────────────────────────────────────────────────
let rulesCache=[];

function onPolicyTabOpen(){
  loadPolicyInfo();
  loadRules();
}

async function loadPolicyInfo(){
  const card=document.getElementById('policy-card');
  card.innerHTML='<div class="policy-unavail">Loading policy info…</div>';
  try{
    const r=await api('/v1/policy');
    if(r.status===404){throw new Error('not implemented')}
    const p=await r.json();
    const path=p.config_path||'Default (embedded standard policy)';
    card.innerHTML=`<div class="policy-card-grid">
      <div class="policy-kv"><span class="pk-label">Config Path</span><span class="pk-value mono">${esc(path)}</span></div>
      <div class="policy-kv"><span class="pk-label">Mode</span><span class="pk-value">${esc(p.mode||'—')}</span></div>
      <div class="policy-kv"><span class="pk-label">Default Action</span><span class="pk-value">${esc(p.default_action||'—')}</span></div>
      <div class="policy-kv"><span class="pk-label">Policies</span><span class="pk-value">${esc(String(p.policy_count??'—'))}</span></div>
      <div class="policy-kv"><span class="pk-label">Rules</span><span class="pk-value">${esc(String(p.rule_count??'—'))}</span></div>
    </div>`;
  }catch(e){
    card.innerHTML='<div class="policy-unavail">Policy info unavailable — endpoint not yet implemented.</div>';
  }
}

async function reloadPolicy(){
  const hint=document.getElementById('reload-hint');
  try{
    await api('/v1/policy/reload',{method:'POST'});
    toast('Policy reloaded');hint.textContent='';
    loadPolicyInfo();
  }catch(e){
    if(e.message.includes('404')||e.message.includes('405')){
      hint.textContent='Restart serve to reload policies';
    }else{
      hint.textContent='Reload failed: '+e.message;
    }
  }
}

async function loadRules(){
  try{
    const r=await api('/v1/rules/auto-allowed');
    const data=await r.json();
    rulesCache=data.rules||[];renderRules(rulesCache);
  }catch(e){toast('Rules error: '+e.message)}
}

function renderRules(rules){
  const tbody=document.getElementById('rules-body');tbody.innerHTML='';
  document.getElementById('rules-empty').style.display=rules.length?'none':'block';
  rules.forEach(r=>{
    const tr=document.createElement('tr');tr.className='row';
    const pattern=r.command_pattern||r.path_pattern||'(default)';
    const created=r.created?new Date(r.created).toLocaleString():'—';
    tr.innerHTML=`<td class="cmd-col mono" title="${esc(pattern)}">${esc(pattern)}</td>
      <td class="col-tool">${esc(r.tool||'')}</td>
      <td style="font-size:11px">${esc(created)}</td>
      <td style="text-align:right"><button class="act-btn revoke" onclick="revokeRule(${r.index})">Revoke</button></td>`;
    tbody.append(tr);
  });
}

async function revokeRule(index){
  if(!confirm('Revoke this auto-allowed rule?'))return;
  try{
    await api('/v1/rules/auto-allowed/'+index,{method:'DELETE'});
    toast('Rule revoked');loadRules();
  }catch(e){toast('Revoke error: '+e.message)}
}
</script>
</body>
</html>
