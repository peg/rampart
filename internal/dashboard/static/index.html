<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rampart Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #09090b; --surface: #18181b; --surface-2: #1e1e22; --surface-3: #27272a;
  --border: #27272a; --border-light: #3f3f46;
  --text: #a1a1aa; --text-bright: #e4e4e7; --heading: #fafafa;
  --accent: #FF6392; --accent-dim: #cc4f75;
  --green: #22c55e; --red: #ef4444; --orange: #f59e0b;
  --radius: 6px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',system-ui,sans-serif;font-size:13px;line-height:1.4;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.mono{font-family:'JetBrains Mono',monospace;font-size:12px}
.wrap{max-width:1200px;margin:0 auto;padding:0 16px}

/* Auth bar */
#auth-bar{padding:12px 0;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border)}
#auth-bar .logo{font-weight:700;font-size:15px;color:var(--heading);margin-right:auto;display:flex;align-items:center;gap:6px}
#auth-bar .logo span{color:var(--accent)}
#token-input{background:var(--surface);border:1px solid var(--border);color:var(--text-bright);padding:6px 10px;border-radius:var(--radius);width:260px;font-size:12px;outline:none}
#token-input:focus{border-color:var(--accent)}
#token-input::placeholder{color:#52525b}
#connect-btn{background:var(--accent);color:#fff;border:none;padding:6px 14px;border-radius:var(--radius);font-size:12px;font-weight:600;cursor:pointer}
#connect-btn:hover{background:var(--accent-dim)}
.conn-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:4px}
.conn-dot.ok{background:var(--green)}.conn-dot.err{background:var(--red)}.conn-dot.wait{background:var(--orange)}

/* Error banner */
#error-banner{display:none;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);color:var(--red);padding:8px 16px;border-radius:var(--radius);margin:8px 0;font-size:12px;align-items:center;gap:8px}
#error-banner button{background:var(--red);color:#fff;border:none;padding:3px 10px;border-radius:var(--radius);cursor:pointer;font-size:11px}

/* Stats bar */
#stats-bar{display:flex;gap:16px;padding:10px 0;border-bottom:1px solid var(--border);font-size:12px;flex-wrap:wrap}
.stat{display:flex;align-items:center;gap:4px}.stat b{color:var(--heading);font-variant-numeric:tabular-nums}

/* Tabs */
.tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-top:2px}
.tab-btn{background:none;border:none;color:var(--text);padding:8px 16px;font-size:13px;cursor:pointer;border-bottom:2px solid transparent;font-weight:500}
.tab-btn:hover{color:var(--text-bright)}.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-panel{display:none}.tab-panel.active{display:block}

/* Table */
.tbl{width:100%;border-collapse:collapse}
.tbl th{text-align:left;padding:6px 8px;font-size:11px;font-weight:600;color:#52525b;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:1}
.tbl td{padding:5px 8px;border-bottom:1px solid var(--border);vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:0}
.tbl tr.row:hover{background:var(--surface)}
.tbl tr.row{cursor:pointer;transition:background .15s}
.tbl tr.row.new-item{animation:fadeHighlight 2s ease-out}
.tbl tr.row.dangerous{border-left:3px solid var(--orange)}
.tbl tr.flash-green{background:rgba(34,197,94,.15)!important}
.tbl tr.flash-red{background:rgba(239,68,68,.15)!important}
@keyframes fadeHighlight{from{background:rgba(255,99,146,.12)}to{background:transparent}}

/* Detail row */
.detail-row td{padding:0!important;border-bottom:1px solid var(--border)}
.detail-inner{max-height:0;overflow:hidden;transition:max-height .25s ease;padding:0 8px}
.detail-row.open .detail-inner{max-height:300px;padding:10px 8px}
.detail-inner .kv{display:grid;grid-template-columns:100px 1fr;gap:4px 12px;font-size:12px}
.detail-inner .kv dt{color:#52525b;font-weight:500}.detail-inner .kv dd{color:var(--text-bright);word-break:break-all}

/* Dot */
.dot{width:6px;height:6px;border-radius:50%;display:inline-block;flex-shrink:0}
.dot.pending{background:var(--orange)}.dot.approved{background:var(--green)}.dot.denied{background:var(--red)}.dot.always{background:var(--accent)}

/* Action buttons */
.actions{display:flex;gap:4px;justify-content:flex-end}
.act-btn{border:none;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:12px;font-weight:600;line-height:1.4}
.act-btn.approve{background:rgba(34,197,94,.15);color:var(--green)}.act-btn.approve:hover{background:rgba(34,197,94,.3)}
.act-btn.always{background:rgba(255,99,146,.12);color:var(--accent)}.act-btn.always:hover{background:rgba(255,99,146,.25)}
.act-btn.deny{background:rgba(239,68,68,.12);color:var(--red)}.act-btn.deny:hover{background:rgba(239,68,68,.25)}

/* Timer */
.timer{font-variant-numeric:tabular-nums;min-width:36px;display:inline-block;text-align:right;font-family:'JetBrains Mono',monospace;font-size:11px}

/* Badges */
.badge{font-size:10px;font-weight:600;padding:1px 6px;border-radius:3px;text-transform:uppercase}
.badge.approved{background:rgba(34,197,94,.15);color:var(--green)}
.badge.denied{background:rgba(239,68,68,.12);color:var(--red)}
.badge.always-allowed{background:rgba(255,99,146,.12);color:var(--accent)}

/* Audit controls */
.audit-controls{display:flex;gap:8px;align-items:center;padding:10px 0;flex-wrap:wrap}
.audit-controls input,.audit-controls select{background:var(--surface);border:1px solid var(--border);color:var(--text-bright);padding:5px 8px;border-radius:var(--radius);font-size:12px;outline:none}
.audit-controls input:focus,.audit-controls select:focus{border-color:var(--accent)}
.audit-controls button{background:var(--surface-3);color:var(--text-bright);border:1px solid var(--border);padding:5px 12px;border-radius:var(--radius);font-size:12px;cursor:pointer}
.audit-controls button:hover{background:var(--border-light)}
.audit-stats{display:flex;gap:12px;font-size:12px;padding:4px 0}

/* Toast */
#toast{position:fixed;bottom:20px;right:20px;background:var(--surface-2);border:1px solid var(--border);color:var(--text-bright);padding:8px 16px;border-radius:var(--radius);font-size:12px;opacity:0;transition:opacity .3s;pointer-events:none;z-index:100}
#toast.show{opacity:1}

/* Empty state */
.empty{text-align:center;padding:40px 0;color:#52525b;font-size:13px}
.empty .icon{font-size:24px;margin-bottom:8px}

/* Load more */
.load-more{text-align:center;padding:10px}
.load-more button{background:var(--surface-3);color:var(--text-bright);border:1px solid var(--border);padding:6px 20px;border-radius:var(--radius);cursor:pointer;font-size:12px}

/* Unauthorized help text (hidden, for test) */
.auth-help{font-size:11px;color:#52525b;margin-top:4px}

/* Revoke button */
.act-btn.revoke{background:rgba(239,68,68,.12);color:var(--red);font-size:11px;padding:2px 8px}
.act-btn.revoke:hover{background:rgba(239,68,68,.25)}

/* Rule link in history */
.rule-link{font-size:10px;cursor:pointer;margin-left:4px}
.rule-link.active{color:var(--accent)}
.rule-link.active:hover{text-decoration:underline}
.rule-link.revoked{color:#52525b;cursor:default}

/* Responsive */
@media(max-width:640px){
  .col-tool,.col-agent{display:none}
  .tbl td.cmd-col{max-width:none;white-space:normal;word-break:break-all}
  #token-input{width:160px}
  .stat:nth-child(n+4){display:none}
}
</style>
</head>
<body>

<div class="wrap">
  <!-- Auth -->
  <div id="auth-bar">
    <div class="logo"><span>◆</span> Rampart Dashboard</div>
    <input type="password" id="token-input" placeholder="API token" autocomplete="off">
    <button id="connect-btn">Connect</button>
    <span class="conn-dot" id="conn-dot"></span>
  </div>
  <p class="auth-help">Unauthorized? Check your token or run <code>rampart token</code> to generate one.</p>

  <div id="error-banner"><span id="error-msg"></span><button onclick="reconnect()">Retry</button></div>

  <!-- Stats -->
  <div id="stats-bar">
    <div class="stat">Pending: <b id="stat-pending">0</b></div>
    <div class="stat">Approved today: <b id="stat-approved">0</b></div>
    <div class="stat">Denied today: <b id="stat-denied">0</b></div>
    <div class="stat">Status: <span id="stat-status" style="color:#52525b">disconnected</span></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="pending">Pending</button>
    <button class="tab-btn" data-tab="history">History</button>
    <button class="tab-btn" data-tab="audit">Audit Log</button>
    <button class="tab-btn" data-tab="rules">Rules</button>
  </div>

  <!-- Pending Panel -->
  <div class="tab-panel active" id="panel-pending">
    <table class="tbl" id="pending-table">
      <thead><tr>
        <th style="width:40px">#</th>
        <th style="width:20px"></th>
        <th class="cmd-col">Command</th>
        <th class="col-tool" style="width:60px">Tool</th>
        <th class="col-agent" style="width:80px">Agent</th>
        <th style="width:50px;text-align:right">Time</th>
        <th style="width:100px;text-align:right">Actions</th>
      </tr></thead>
      <tbody id="pending-body"></tbody>
    </table>
    <div class="empty" id="pending-empty"><div class="icon">✓</div>No pending approvals — all clear</div>
  </div>

  <!-- History Panel -->
  <div class="tab-panel" id="panel-history">
    <table class="tbl" id="history-table">
      <thead><tr>
        <th style="width:40px">#</th>
        <th style="width:20px"></th>
        <th class="cmd-col">Command</th>
        <th class="col-tool" style="width:60px">Tool</th>
        <th class="col-agent" style="width:80px">Agent</th>
        <th style="width:90px">Result</th>
        <th style="width:100px;text-align:right">Time</th>
      </tr></thead>
      <tbody id="history-body"></tbody>
    </table>
    <div class="empty" id="history-empty">No resolved approvals yet</div>
  </div>

  <!-- Audit Panel -->
  <div class="tab-panel" id="panel-audit">
    <div class="audit-controls">
      <input type="date" id="audit-date">
      <select id="audit-tool"><option value="">All tools</option><option value="exec">exec</option><option value="write">write</option><option value="read">read</option><option value="fetch">fetch</option></select>
      <select id="audit-action"><option value="">All actions</option><option value="allow">allow</option><option value="deny">deny</option><option value="require_approval">require_approval</option></select>
      <select id="audit-agent"><option value="">All agents</option></select>
      <button onclick="loadAudit(true)">Search</button>
      <button onclick="exportAudit()">Export</button>
    </div>
    <div class="audit-stats" id="audit-stats"></div>
    <table class="tbl" id="audit-table">
      <thead><tr>
        <th style="width:70px">Time</th>
        <th class="cmd-col">Command</th>
        <th class="col-tool" style="width:60px">Tool</th>
        <th style="width:60px">Action</th>
        <th class="col-agent" style="width:80px">Agent</th>
      </tr></thead>
      <tbody id="audit-body"></tbody>
    </table>
    <div class="empty" id="audit-empty" style="display:none">No audit events for this date</div>
    <div class="load-more" id="audit-more" style="display:none"><button onclick="loadAudit(false)">Load more</button></div>
  </div>
  <!-- Rules Panel -->
  <div class="tab-panel" id="panel-rules">
    <table class="tbl" id="rules-table">
      <thead><tr>
        <th style="width:40px">#</th>
        <th class="cmd-col">Command Pattern</th>
        <th class="col-tool" style="width:60px">Tool</th>
        <th style="width:140px">Created</th>
        <th style="width:80px;text-align:right">Actions</th>
      </tr></thead>
      <tbody id="rules-body"></tbody>
    </table>
    <div class="empty" id="rules-empty">No auto-allowed rules. Use 'Always Allow' on a pending approval to create one.</div>
  </div>
</div>

<div id="toast"></div>

<script>
'use strict';
const DANGEROUS=[/^rm\s/,/^chmod\s/,/^chown\s/,/^kill\s/,/^killall\s/,/^pkill\s/,/^dd\s/,/^mkfs/,/^fdisk/,/^reboot/,/^shutdown/,/^halt/,/^systemctl\s+(stop|disable|restart)/,/\bsudo\b/,/\brm\s+-rf\b/,/^ssh\b.*\breboot\b/,/^curl\b.*\|\s*(ba)?sh/];
function isDangerous(cmd){return DANGEROUS.some(r=>r.test(cmd||''))}

let token='',pollTimer=null,connected=false,expandedId=null;
const pendingMap=new Map(),history=[];
let auditOffset=0,auditHasMore=false;

// Sequential numbering
let seqCounter=0;
const seqMap=new Map(); // approval ID → seq number
function getSeq(id){if(!seqMap.has(id))seqMap.set(id,++seqCounter);return seqMap.get(id)}

// Rules state
let rulesCache=[];

// Init
(function(){
  const p=new URLSearchParams(location.search).get('token');
  if(p){token=p;localStorage.setItem('rampart_token',p)}
  else token=localStorage.getItem('rampart_token')||'';
  document.getElementById('token-input').value=token;
  if(token)connect();

  // Tab switching
  document.querySelector('.tabs').addEventListener('click',e=>{
    const btn=e.target.closest('.tab-btn');if(!btn)return;
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('panel-'+btn.dataset.tab).classList.add('active');
    if(btn.dataset.tab==='audit'&&!document.getElementById('audit-date').value){
      document.getElementById('audit-date').value=todayStr();loadAudit(true);loadAuditStats();
    }
    if(btn.dataset.tab==='rules')loadRules();
  });

  // Connect
  document.getElementById('connect-btn').addEventListener('click',connect);
  document.getElementById('token-input').addEventListener('keydown',e=>{if(e.key==='Enter')connect()});

  // Event delegation for pending table
  document.getElementById('pending-table').addEventListener('click',handlePendingClick);
  document.getElementById('history-table').addEventListener('click',handleHistoryClick);

  // Visibility
  document.addEventListener('visibilitychange',()=>{
    if(document.hidden){clearTimeout(pollTimer)}
    else if(connected)poll();
  });
})();

function todayStr(){return new Date().toISOString().slice(0,10)}
function setDot(cls){const d=document.getElementById('conn-dot');d.className='conn-dot '+cls}
function showError(msg){const b=document.getElementById('error-banner');b.style.display='flex';document.getElementById('error-msg').textContent=msg}
function hideError(){document.getElementById('error-banner').style.display='none'}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}

function connect(){
  token=document.getElementById('token-input').value.trim();
  if(!token)return;
  localStorage.setItem('rampart_token',token);
  setDot('wait');
  document.getElementById('stat-status').textContent='connecting';
  document.getElementById('stat-status').style.color='var(--orange)';
  poll();
}
function reconnect(){hideError();connect()}

async function api(path,opts={}){
  const r=await fetch(path,{...opts,headers:{'Authorization':'Bearer '+token,...(opts.headers||{})}});
  if(!r.ok)throw new Error(r.status+' '+r.statusText);
  return r;
}

async function poll(){
  clearTimeout(pollTimer);
  try{
    const r=await api('/v1/approvals');
    const data=await r.json();
    if(!connected){connected=true;setDot('ok');hideError();document.getElementById('stat-status').textContent='connected';document.getElementById('stat-status').style.color='var(--green)'}
    updatePending(data.approvals||[]);
    const delay=pendingMap.size>0?2000:5000;
    if(!document.hidden)pollTimer=setTimeout(poll,delay);
  }catch(e){
    connected=false;setDot('err');
    document.getElementById('stat-status').textContent='error';document.getElementById('stat-status').style.color='var(--red)';
    showError('Connection failed: '+e.message);
    pollTimer=setTimeout(poll,10000);
  }
}

function updatePending(approvals){
  const incoming=new Map(approvals.map(a=>[a.id,a]));
  // Remove resolved
  for(const[id]of pendingMap){
    if(!incoming.has(id)){
      const el=document.getElementById('row-'+id);
      const det=document.getElementById('det-'+id);
      if(el)el.remove();if(det)det.remove();
      pendingMap.delete(id);
    }
  }
  // Add/update
  const tbody=document.getElementById('pending-body');
  for(const a of approvals){
    if(pendingMap.has(a.id)){
      pendingMap.set(a.id,a);
      updateTimerCell(a);
    }else{
      pendingMap.set(a.id,a);
      const{row,detail}=createPendingRow(a);
      tbody.prepend(detail);tbody.prepend(row);
      row.classList.add('new-item');
    }
  }
  // Stats
  document.getElementById('stat-pending').textContent=pendingMap.size;
  const pe=document.getElementById('pending-empty');
  pe.style.display=pendingMap.size?'none':'block';
  updateTimers();
}

function extractCmd(a){
  if(a.command)return a.command;
  if(a.request&&a.request.command)return Array.isArray(a.request.command)?a.request.command.join(' '):a.request.command;
  if(a.description)return a.description;
  return a.id||'unknown';
}

function createPendingRow(a){
  const cmd=extractCmd(a);const danger=isDangerous(cmd);
  const tr=document.createElement('tr');tr.className='row'+(danger?' dangerous':'');tr.id='row-'+a.id;tr.dataset.id=a.id;
  const seq=getSeq(a.id);
  tr.innerHTML=`<td class="mono" style="color:#52525b;font-size:11px">#${seq}</td>
    <td><span class="dot pending"></span>${danger?'<span style="color:var(--orange);margin-left:2px" title="Potentially dangerous">⚠</span>':''}</td>
    <td class="cmd-col mono" title="${esc(cmd)}">${esc(cmd)}</td>
    <td class="col-tool">${esc(a.tool||'')}</td>
    <td class="col-agent">${esc(a.agent||'')}</td>
    <td style="text-align:right"><span class="timer" id="timer-${a.id}"></span></td>
    <td><div class="actions">
      <button class="act-btn approve" data-action="approve" data-id="${a.id}" title="Approve">✓</button>
      <button class="act-btn always" data-action="always" data-id="${a.id}" title="Always allow this command pattern (creates permanent rule)">★ Always</button>
      <button class="act-btn deny" data-action="deny" data-id="${a.id}" title="Deny">✗</button>
    </div></td>`;

  const det=document.createElement('tr');det.className='detail-row';det.id='det-'+a.id;
  det.innerHTML=`<td colspan="7"><div class="detail-inner"><dl class="kv">
    <dt>ID</dt><dd class="mono">${esc(a.id)}</dd>
    <dt>Command</dt><dd class="mono">${esc(cmd)}</dd>
    <dt>Tool</dt><dd>${esc(a.tool||'—')}</dd>
    <dt>Agent</dt><dd>${esc(a.agent||'—')}</dd>
    <dt>Message</dt><dd>${esc(a.message||a.description||'—')}</dd>
    <dt>Created</dt><dd>${a.created_at?new Date(a.created_at).toLocaleString():'—'}</dd>
    <dt>Expires</dt><dd>${a.expires_at?new Date(a.expires_at).toLocaleString():'—'}</dd>
  </dl></div></td>`;
  return{row:tr,detail:det};
}

function handlePendingClick(e){
  const btn=e.target.closest('.act-btn');
  if(btn){
    e.stopPropagation();
    if(btn.dataset.action==='always'){
      const cmd=extractCmd(pendingMap.get(btn.dataset.id)||{});
      if(!confirm('Always Allow will create a permanent rule that auto-approves similar commands.\n\nCommand: '+cmd+'\n\nThis can be revoked later in the Rules tab. Continue?'))return;
    }
    resolveApproval(btn.dataset.id,btn.dataset.action);
    return;
  }
  const row=e.target.closest('tr.row');
  if(!row)return;
  const id=row.dataset.id;
  const det=document.getElementById('det-'+id);if(!det)return;
  if(expandedId&&expandedId!==id){document.getElementById('det-'+expandedId)?.classList.remove('open')}
  det.classList.toggle('open');
  expandedId=det.classList.contains('open')?id:null;
}

function handleHistoryClick(e){
  const row=e.target.closest('tr.row');if(!row)return;
  const det=row.nextElementSibling;if(!det||!det.classList.contains('detail-row'))return;
  det.classList.toggle('open');
}

async function resolveApproval(id,action){
  const approved=action!=='deny';const persist=action==='always';
  const row=document.getElementById('row-'+id);
  if(row)row.classList.add(approved?'flash-green':'flash-red');
  try{
    await api('/v1/approvals/'+id+'/resolve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({approved,resolved_by:'dashboard',persist})});
    const a=pendingMap.get(id);
    if(a){
      a.resolution=action==='always'?'always-allowed':(approved?'approved':'denied');
      a.resolved_at=new Date().toISOString();a.resolved_by='dashboard';
      addToHistory(a);
    }
    setTimeout(()=>{
      document.getElementById('row-'+id)?.remove();
      document.getElementById('det-'+id)?.remove();
      pendingMap.delete(id);
      document.getElementById('stat-pending').textContent=pendingMap.size;
      if(!pendingMap.size)document.getElementById('pending-empty').style.display='block';
      updateHistoryStats(action);
    },400);
    if(persist)toast('Rule saved — always allowed');
  }catch(e){toast('Error: '+e.message)}
}

let approvedToday=0,deniedToday=0;
function updateHistoryStats(action){
  if(action==='deny'){deniedToday++;document.getElementById('stat-denied').textContent=deniedToday}
  else{approvedToday++;document.getElementById('stat-approved').textContent=approvedToday}
}

function addToHistory(a){
  history.unshift(a);if(history.length>100)history.pop();
  renderHistoryRow(a,true);
  document.getElementById('history-empty').style.display='none';
}

function renderHistoryRow(a,prepend){
  const cmd=extractCmd(a);
  const tbody=document.getElementById('history-body');
  const tr=document.createElement('tr');tr.className='row';tr.dataset.id=a.id;
  const res=a.resolution||'approved';
  const dotCls=res==='denied'?'denied':(res==='always-allowed'?'always':'approved');
  const seq=getSeq(a.id);
  let ruleBadge='';
  if(res==='always-allowed'){
    const ruleActive=rulesCache.some(r=>r.tool===(a.tool||'')&&(r.command_pattern===cmd||r.command_pattern===engine_generalize(cmd)));
    ruleBadge=ruleActive?
      ' <span class="rule-link active" onclick="event.stopPropagation();switchTab(\'rules\')">Rule active</span>':
      ' <span class="rule-link revoked">Rule revoked</span>';
  }
  tr.innerHTML=`<td class="mono" style="color:#52525b;font-size:11px">#${seq}</td>
    <td><span class="dot ${dotCls}"></span></td>
    <td class="cmd-col mono" title="${esc(cmd)}">${esc(cmd)}</td>
    <td class="col-tool">${esc(a.tool||'')}</td>
    <td class="col-agent">${esc(a.agent||'')}</td>
    <td><span class="badge ${res}">${res}</span>${ruleBadge}</td>
    <td style="text-align:right;font-size:11px">${a.resolved_at?timeAgo(a.resolved_at):''}</td>`;
  const det=document.createElement('tr');det.className='detail-row';
  det.innerHTML=`<td colspan="7"><div class="detail-inner"><dl class="kv">
    <dt>ID</dt><dd class="mono">${esc(a.id)}</dd>
    <dt>Command</dt><dd class="mono">${esc(cmd)}</dd>
    <dt>Resolved by</dt><dd>${esc(a.resolved_by||'—')}</dd>
    <dt>Resolved at</dt><dd>${a.resolved_at?new Date(a.resolved_at).toLocaleString():'—'}</dd>
  </dl></div></td>`;
  if(prepend){tbody.prepend(det);tbody.prepend(tr)}else{tbody.append(tr);tbody.append(det)}
}

function updateTimers(){
  for(const[id,a]of pendingMap)updateTimerCell(a);
  if(pendingMap.size&&!document.hidden)requestAnimationFrame(()=>setTimeout(updateTimers,1000));
}
function updateTimerCell(a){
  const el=document.getElementById('timer-'+a.id);if(!el)return;
  if(!a.expires_at){el.textContent='—';return}
  const rem=Math.max(0,Math.floor((new Date(a.expires_at)-Date.now())/1000));
  const m=Math.floor(rem/60),s=rem%60;
  el.textContent=m+':'+String(s).padStart(2,'0');
  if(rem<30)el.style.color='var(--red)';else if(rem<60)el.style.color='var(--orange)';else el.style.color='';
}

function timeAgo(iso){
  const s=Math.floor((Date.now()-new Date(iso))/1000);
  if(s<60)return s+'s ago';if(s<3600)return Math.floor(s/60)+'m ago';
  return Math.floor(s/3600)+'h ago';
}

// Audit
async function loadAudit(reset){
  if(reset)auditOffset=0;
  const date=document.getElementById('audit-date').value;if(!date)return;
  const tool=document.getElementById('audit-tool').value;
  const action=document.getElementById('audit-action').value;
  const agent=document.getElementById('audit-agent').value;
  let url=`/v1/audit/events?date=${date}&limit=50&offset=${auditOffset}`;
  if(tool)url+=`&tool=${tool}`;if(action)url+=`&action=${action}`;if(agent)url+=`&agent=${agent}`;
  try{
    const r=await api(url);const data=await r.json();
    const tbody=document.getElementById('audit-body');
    if(reset)tbody.innerHTML='';
    const events=data.events||[];
    events.forEach(ev=>{
      const tr=document.createElement('tr');tr.className='row';
      const t=ev.timestamp?new Date(ev.timestamp).toLocaleTimeString():'';
      const cmd=ev.command||ev.description||'—';
      tr.innerHTML=`<td style="font-size:11px">${t}</td>
        <td class="cmd-col mono" title="${esc(cmd)}">${esc(cmd)}</td>
        <td class="col-tool">${esc(ev.tool||'')}</td>
        <td><span class="badge ${ev.action||''}">${esc(ev.action||'')}</span></td>
        <td class="col-agent">${esc(ev.agent||'')}</td>`;
      tbody.append(tr);
    });
    auditOffset+=events.length;
    auditHasMore=events.length>=50;
    document.getElementById('audit-more').style.display=auditHasMore?'block':'none';
    document.getElementById('audit-empty').style.display=(!reset&&!events.length)||(reset&&!events.length)?'block':'none';
  }catch(e){toast('Audit error: '+e.message)}
}

async function loadAuditStats(){
  const date=document.getElementById('audit-date').value;if(!date)return;
  try{
    const r=await api(`/v1/audit/stats?from=${date}&to=${date}`);const s=await r.json();
    const el=document.getElementById('audit-stats');
    el.innerHTML=`<div class="stat">Total: <b>${s.total_events||0}</b></div>`+
      Object.entries(s.by_action||{}).map(([k,v])=>`<div class="stat">${k}: <b>${v}</b></div>`).join('');
  }catch(e){}
}

async function exportAudit(){
  const date=document.getElementById('audit-date').value;if(!date)return;
  try{
    const r=await api(`/v1/audit/export?date=${date}`);const blob=await r.blob();
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`audit-${date}.jsonl`;a.click();
  }catch(e){toast('Export error: '+e.message)}
}

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

// Simplified client-side generalize (for rule matching heuristic)
function engine_generalize(cmd){
  if(!cmd)return'*';const t=cmd.trim().split(/\s+/);
  if(t.length<=1)return t[0]||'*';
  if(t.length<=2)return t.join(' ')+' *';
  return t[0]+' '+t[1]+' *';
}

function switchTab(name){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  const btn=document.querySelector(`.tab-btn[data-tab="${name}"]`);
  if(btn)btn.classList.add('active');
  document.getElementById('panel-'+name)?.classList.add('active');
  if(name==='rules')loadRules();
}

async function loadRules(){
  try{
    const r=await api('/v1/rules/auto-allowed');
    const data=await r.json();
    rulesCache=data.rules||[];
    renderRules(rulesCache);
  }catch(e){toast('Rules error: '+e.message)}
}

function renderRules(rules){
  const tbody=document.getElementById('rules-body');
  tbody.innerHTML='';
  document.getElementById('rules-empty').style.display=rules.length?'none':'block';
  rules.forEach((r,i)=>{
    const tr=document.createElement('tr');tr.className='row';
    const pattern=r.command_pattern||r.path_pattern||'(default)';
    const created=r.created?new Date(r.created).toLocaleString():'—';
    tr.innerHTML=`<td class="mono" style="color:#52525b;font-size:11px">${r.index}</td>
      <td class="cmd-col mono" title="${esc(pattern)}">${esc(pattern)}</td>
      <td class="col-tool">${esc(r.tool||'')}</td>
      <td style="font-size:11px">${created}</td>
      <td style="text-align:right"><button class="act-btn revoke" onclick="revokeRule(${r.index})">Revoke</button></td>`;
    tbody.append(tr);
  });
}

async function revokeRule(index){
  if(!confirm('Revoke this auto-allowed rule?'))return;
  try{
    await api('/v1/rules/auto-allowed/'+index,{method:'DELETE'});
    toast('Rule revoked');
    loadRules();
  }catch(e){toast('Revoke error: '+e.message)}
}
</script>
</body>
</html>
