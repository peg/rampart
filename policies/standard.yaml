# Rampart Standard Policy — default rules for common AI agent threats.
#
# IMPORTANT: Pattern matching limitations
# These rules use glob patterns against the literal command string.
# They protect against well-behaved AI agents, NOT adversarial humans.
# Evasion techniques like quoted binaries ('rm' -rf /), escaped chars
# (\rm -rf /), variable expansion ($CMD), or base64-encoded payloads
# will bypass glob matching. For adversarial threat models, combine
# Rampart with OS-level sandboxing (containers, seccomp, AppArmor).
#
# See docs/THREAT-MODEL.md for the full discussion.

version: "1"
default_action: allow
policies:
  - name: block-destructive
    match:
      tool: ["exec"]
    rules:
      - action: deny
        when:
          command_matches:
            - "rm -rf /"
            - "rm -rf ~"
            - "rm -rf /*"
            - "rm -rf ~/*"
            - ":(){ :|:& };:"
            - "dd if=*"
            - "mkfs*"
            - "chmod -R 777 /"
            - "> /dev/sda"
        message: "Destructive command blocked"
      - action: deny
        when:
          command_matches:
            - "nc -e *"
            - "nc -c *"
            - "ncat -e *"
            - "bash -i >*"
            - "python* -c *import socket*connect*"
            - "perl -e *socket*"
            - "ruby -rsocket*"
        message: "Reverse shell detected"
      - action: deny
        when:
          command_matches:
            - "crontab -r"
            - "crontab -r *"
        message: "Crontab deletion blocked"
      - action: deny
        when:
          command_matches:
            - "curl * | bash"
            - "curl * | sh"
            - "wget * | bash"
            - "wget * | sh"
            - "curl * | python*"
            - "curl * | perl*"
            - "curl -s * | *"
            - "wget -q * | *"
        message: "Piped execution blocked (supply chain risk)"

  - name: require-privileged-approval
    match:
      tool: ["exec"]
    rules:
      - action: require_approval
        when:
          command_matches:
            - "sudo *"
        message: "sudo requires approval"

  - name: block-credential-access
    match:
      tool: ["read"]
    rules:
      - action: deny
        when:
          path_matches:
            - "**/.ssh/id_*"
          path_not_matches:
            - "**/*.pub"
      - action: deny
        when:
          path_matches:
            - "**/.aws/credentials"
            - "**/.env"
            - "**/.netrc"
            - "**/token*"
            - "**/.git-credentials"
        message: "Credential file access blocked"

  - name: block-credential-commands
    match:
      tool: ["exec"]
    rules:
      - action: deny
        when:
          command_matches:
            - "cat */.ssh/*"
            - "cat */.aws/*"
            - "cat */.env"
            - "cat */.netrc"
            - "cat */.git-credentials"
            - "head */.ssh/*"
            - "tail */.ssh/*"
            - "less */.ssh/*"
            - "more */.ssh/*"
            - "base64 */.ssh/*"
            - "base64 */.aws/*"
            - "cp */.ssh/*"
            - "cp */.aws/*"
            - "cat /etc/shadow"
            - "cat /etc/passwd"
            - "cat /etc/gshadow"
            - "cat /etc/master.passwd"
            - "head /etc/shadow"
            - "tail /etc/shadow"
            - "less /etc/shadow"
            - "more /etc/shadow"
            - "grep * /etc/shadow"
            - "cat /etc/sudoers"
            - "cat */.bash_history"
            - "cat */.zsh_history"
            - "cat */.python_history"
            - "cat */.*_history"
            - "cat /etc/sudoers.d/*"
            - "cat /proc/**/environ"
        message: "Credential file access via shell blocked"

  - name: block-sensitive-writes
    match:
      tool: ["write", "edit"]
    rules:
      - action: deny
        when:
          path_matches:
            - "/etc/**"
            - "/usr/**"
            - "/bin/**"
            - "/sbin/**"
            - "**/.ssh/**"
            - "**/.aws/**"
            - "**/.bashrc"
            - "**/.bash_profile"
            - "**/.zshrc"
            - "**/.profile"
        message: "Write to sensitive path blocked"

  - name: block-exfil-domains
    match:
      tool: ["fetch"]
    rules:
      - action: deny
        when:
          domain_matches:
            - "*.ngrok.io"
            - "*.ngrok-free.app"
            - "*.requestbin.com"
            - "requestbin.com"
            - "*.hookbin.com"
            - "hookbin.com"
            - "*.webhook.site"
            - "webhook.site"
            - "*.pipedream.net"
            - "pipedream.net"
            - "*.beeceptor.com"
            - "beeceptor.com"
        message: "Potential data exfiltration domain blocked"

  - name: block-mcp-destructive
    match:
      tool: ["mcp-destructive"]
    rules:
      - action: deny
        message: "Destructive MCP operation blocked (delete/destroy/remove/drop)"

  - name: log-mcp-dangerous
    match:
      tool: ["mcp-dangerous"]
    rules:
      - action: log
        message: "Dangerous MCP operation logged (stop/restart/execute/modify)"

  - name: block-credential-leaks
    match:
      tool: ["exec", "read"]
    rules:
      - action: deny
        when:
          response_matches:
            - "AKIA[0-9A-Z]{16}"
            - "-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----"
            - "ghp_[a-zA-Z0-9]{36}"
            - "sk-[a-zA-Z0-9]{48}"
            - "xox[bsapr]-[a-zA-Z0-9-]+"
            - "eyJ[a-zA-Z0-9_-]+\\.eyJ[a-zA-Z0-9_-]+"
        message: "Sensitive credential detected in response"

# ---------------------------------------------------------------------------
# APPROVAL EXAMPLES (uncomment and customize)
# ---------------------------------------------------------------------------
# Use require_approval for commands that aren't dangerous enough to block
# outright, but risky enough that a human should decide.
#
# How it works:
#   - Claude Code: shows a native approval prompt
#   - MCP clients: blocks until resolved via API or dashboard
#   - OpenClaw: sends a chat message you can approve inline
#   - Webhooks: sends a notification with a signed approve/deny link
#
#  - name: approve-deployments
#    match:
#      tool: ["exec"]
#    rules:
#      - action: require_approval
#        when:
#          command_matches:
#            - "kubectl apply *"
#            - "kubectl delete *"
#            - "terraform apply *"
#            - "docker push *"
#            - "helm install *"
#            - "helm upgrade *"
#        message: "Deployment command — approve or deny?"
#
#  - name: approve-installs
#    match:
#      tool: ["exec"]
#    rules:
#      - action: require_approval
#        when:
#          command_matches:
#            - "pip install *"
#            - "npm install *"
#            - "cargo install *"
#            - "apt install *"
#            - "brew install *"
#        message: "Package install — approve or deny?"

  # Note: block-credential-leaks above handles response-side scanning.
  # It detects credentials leaked in PostToolUse tool output (Claude Code, Cline).
